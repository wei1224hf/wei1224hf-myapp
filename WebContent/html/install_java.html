<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv=content-type content="text/html; charset=UTF-8">
<script src="../libs/jquery-1.3.2.min.js" type="text/javascript"></script>
<style type="text/css">
.log {
	background-color: #999999
}

.log_done {
	background-color: #EEEEEE
}

.btn_done{
	background-color: #E0E0E0
}

.f_close{
	display: none
}

.f_step{
	display: block
}
</style>
	<script type="text/javascript">
	
		var server_path = "../jsp/install.jsp";
		var init_dom = function() {
			var language = {
				"step" : "步骤"
				,"steps" : [
						 "检查系统环境,包括:检查 JAVA版本,检查核心文件及文件夹的执行权限"
						,"配置安装模式,数据库连接参数,系统语言"
						,"初始化数据库表"
						,"初始化 权限,用户组,管理员帐号 等基础数据"
						,"模拟基础的业务数据:用户,用户组,科目,简单的练习卷.你也可以跳过这一步,直接登录系统首页: <a href='../html/desktop.html' target='_blank'>首页</a> 帐号密码都是 admin "
						,"模拟学生练习记录"
						,"模拟多人考卷"
						,"多人考卷执行批改" ]
				,"database":{
					"name":"数据库名称"
					,"port":"端口"
					,"username":"帐号"
					,"password":"密码"
					,"host":"域名"
					,"mode":"安装模式"
				} 
				,"language":"语言"
				           
			};

			var buttons = $(".btn_step");
			for (var i = 0; i < buttons.length; i++) {
				$(buttons[i]).html(language.step + " " + (i + 1));
				$($(".directions_step")[i]).html(language.steps[i]);
			}
			
			$('#mode').html(language.database.mode);
			$('#host').html(language.database.host);
			$('#username').html(language.database.username);
			$('#password').html(language.database.password);
			$('#name').html(language.database.name);
			$('#port').html(language.database.port);
			$('#language').html(language.language);
		}

		var on_mode_changed = function() {
			var value = $('#mode').val();
			if (value != 'WLS') {
				$('#host').attr('disabled', true);
				$('#unm').attr('disabled', true);
				$('#pwd').attr('disabled', true);
				$('#port').attr('disabled', true);
				$('#db').attr('disabled', true);
			} else {
				$('#host').attr('disabled', false);
				$('#unm').attr('disabled', false);
				$('#pwd').attr('disabled', false);
				$('#port').attr('disabled', false);
				$('#db').attr('disabled', false);
			}

			if (value == 'BAIDU')
				$('#db').attr('disabled', false);
		}

		var step1 = function() {
			$('#check_env').attr("disabled", true);
			$.ajax({
				url : server_path+"?class=install&function=step1",
				dataType : 'json',
				type : "POST",
				data : {
					executor : "",
					session : ""
				},
				success : function(response) {
					var log_doms = $('.log');
					var btn_doms = $('.btn_step');
					$(log_doms[0]).append(response.msg + "<br/>");
					if (response.status == "1") {
						$(btn_doms[0]).attr("disabled", true);
						$(btn_doms[0]).attr("class", "btn_done");
						$(log_doms[0]).attr("class", "log_done");
						$($(".f_close")[0]).attr("class", "f_step");
					} else {
						$(btn_doms[0]).attr("disabled", false);
					}
				},
				error : function(response) {
					$(log_doms[0]).append(response.responseText);
					$(btn_doms[0]).attr("disabled", false);
					$(btn_doms[0]).attr("class", "btn_step");
				}
			});
		}

		var step2 = function() {
			var status = 1;

			var host = $('[name=host]').val();
			if (host == null || host == "")status = 0;

			var unm = $('[name=unm]').val();
			if (unm == null || unm == "")status = 0;

			var pwd = $('[name=pwd]').val();
			//if(pwd==null||pwd=="")status = 0;

			var port = $('[name=port]').val();
			//if(port==null||port=="")status = 0;

			var db = $('[name=db]').val();
			if (db == null || db == "")status = 0;

			if (status == 0) {
				alert("Must input everything");
				return;
			}

			$('#btn_db').attr("disabled", true);
			$.ajax({
				url : server_path+"?class=install&function=step2",
				dataType : 'json',
				type : "POST",
				data : {
					executor : "",
					session : ""

					,
					unm : unm,
					host : host,
					pwd : pwd,
					db : db,
					port : port,
					il8n : $('#il8n').val(),
					mode : $('#mode').val()
				},
				success : function(response) {
					var log_doms = $('.log');
					var btn_doms = $('.btn_step');
					$(log_doms[0]).append(response.msg + "<br/>");
					if (response.status == "1") {
						$(btn_doms[0]).attr("disabled", true);
						$(btn_doms[0]).attr("class", "btn_done");
						$(log_doms[0]).attr("class", "log_done");
						$($(".f_close")[0]).attr("class", "f_step");
					} else {
						$(btn_doms[0]).attr("disabled", false);
					}
				},
				error : function(response) {
					$(log_doms[0]).append(response.responseText);
					$(btn_doms[0]).attr("disabled", false);
					$(btn_doms[0]).attr("class", "btn_step");
				}
			});
		}

		var step3_1 = function() {
			$('#btn_init').attr("disabled", true);
			$.ajax({
				url : server_path+"?class=install&function=step3_1",
				dataType : 'json',
				type : "POST",
				data : {
					executor : "",
					session : ""
				},
				success : function(response) {
					var log_doms = $('.log');
					var btn_doms = $('.btn_step');
					$(log_doms[0]).append(response.msg + "<br/>");
					if (response.status == "1") {
						$(btn_doms[0]).attr("disabled", true);
						$(btn_doms[0]).attr("class", "btn_done");
						$(log_doms[0]).attr("class", "log_done");
						$($(".f_close")[0]).attr("class", "f_step");
					} else {
						$(btn_doms[0]).attr("disabled", false);
					}
				},
				error : function(response) {
					$(log_doms[0]).append(response.responseText);
					$(btn_doms[0]).attr("disabled", false);
					$(btn_doms[0]).attr("class", "btn_step");
				}
			});
		}

		var sqls = [];
		var offset = 0;
		var step3 = function() {
			var sqls_ = [];
			for (var i = offset; (i < offset + 20) && (i < sqls.length - 1); i++) {
				sqls_.push(sqls[i]);
			}
			$.ajax({
				url : server_path+"?class=install&function=init_tables_dosql",
				dataType : 'json',
				type : "POST",
				data : {
					executor : "",
					session : "",
					sqls : $.ligerui.toJSON(sqls_)
				},
				success : function(response) {
					$('#log_init').append(response.msg + "<br/>");
					if (response.status == "1") {
						$('#btn_init').attr("disabled", true);
						$('#log_init').attr("class", "log_done");
						offset += 20;
						if (offset <= sqls.length - 1) {
							init_tables_dosql();
						} else {
							$('#step4').css("display", "block");
						}
					} else {
						$('#btn_init').attr("disabled", false);
					}
				},
				error : function(response) {
					alert("net error");
					$('#btn_init').attr("disabled", false);
				}
			});
		};

		var basic_data = function() {
			$('#btn_basic_data').attr("disabled", true);
			$.ajax({
				url : server_path+"?class=install&function=basic_data",
				dataType : 'json',
				type : "POST",
				data : {
					executor : "",
					session : ""
				},
				success : function(response) {
					$('#log_basic_data').append(response.msg + "<br/>");
					if (response.status == "1") {
						$('#btn_basic_data').attr("disabled", true);
						$('#log_basic_data').attr("class", "log_done");
						$('#step5').css("display", "block");
					} else {
						$('#btn_basic_data').attr("disabled", false);
					}
				},
				error : function(response) {
					alert("net error");
					$('#btn_insert').attr("disabled", false);
				}
			});
		}

	</script>
</head>
<body onload="init_dom()">

	<fieldset class='f_step'>
		<legend>
			<button onclick="step1()" class='btn_step'></button>
		</legend>
		<div class="directions_step"></div>
		<div class='log'></div>
	</fieldset>

	<fieldset class='f_close'>
		<legend>
			<button onclick="step2()" class='btn_step'></button>
		</legend>
		<div class="directions_step"></div><br /> 
		<span id='mode'></span>:
		<select id='mode' onchange='on_mode_changed()'>
			<option value='independent'>independent</span></option>
			<option value="BaiduCloud">BaiduCloud</option>
		</select><br /> 
		<span id='host'></span>:<input name='host' value='localhost'><br />
		<span id='username'></span>:<input name='unm' value='root'><br /> 
		<span id='password'></span>:<input name='pwd' value=''><br /> 
		<span id='port'></span>:<input name='port' value='3306'><br /> 
		<span id='name'></span>:<input name='db' value='myapp'><br /> 
		<span id='language'></span>:<select name='il8n'>
				<option value='zh-cn'>简体中文</option>
				<!-- option value='en'>Enghlish</option --></select><br />
		<div class='log'></div>
	</fieldset>

	<fieldset class='f_close'>
		<legend>
			<button onclick="step3()" id='btn_init' class='btn_step'></button>
		</legend>
		<div class="directions_step"></div>
		<div class='log'></div>
	</fieldset>

	<fieldset class='f_close'>
		<legend>
			<button onclick="basic_data()" id='btn_basic_data' class='btn_step'></button>
		</legend>
		<div class="directions_step"></div>
		<div id='log_basic_data' class='log'></div>
	</fieldset>

</body>
</html>